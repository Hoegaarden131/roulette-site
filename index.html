<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мессенджер</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; }
        header, footer { background: #2a496f; color: white; text-align: center; padding: 10px; }
        .container { display: flex; height: calc(100vh - 80px); }
        .menu { width: 250px; background: #3b5998; color: white; padding: 10px; }
        .menu a { color: white; padding: 10px; text-decoration: none; display: block; }
        .menu a:hover { background: #4c70b0; }
        .content { flex: 1; display: flex; }
        .chat-list { width: 250px; border-right: 1px solid #ccc; padding: 10px; }
        .chat-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #ccc; display: flex; align-items: center; }
        .chat-item img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .chat-item.active { background: #f0f0f0; }
        .chat-content { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 10px; border-bottom: 1px solid #ccc; }
        .chat-body { flex: 1; overflow-y: auto; padding: 10px; }
        .message { margin: 5px 0; padding: 10px; border-radius: 5px; max-width: 70%; position: relative; }
        .from-me { background: #d9edf7; align-self: flex-end; }
        .from-them { background: #f5f5f5; align-self: flex-start; }
        .time { font-size: 0.8em; color: #777; position: absolute; bottom: 5px; right: 10px; }
        .send-panel { display: flex; padding: 10px; border-top: 1px solid #ccc; }
        .send-panel input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .send-panel button { padding: 10px; margin-left: 10px; background: #3b5998; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .send-panel button:hover { background: #4c70b0; }
        .file-input { display: none; }
        .attach-button { padding: 10px; margin-left: 10px; background: #3b5998; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .attach-button:hover { background: #4c70b0; }
        .notification { position: fixed; bottom: 10px; right: 10px; background: #3b5998; color: white; padding: 10px; border-radius: 5px; display: none; }
        .auth-form { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .auth-form div { margin-bottom: 10px; }
        .auth-form input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .auth-form button { padding: 10px; background: #3b5998; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .auth-form button:hover { background: #4c70b0; }
    </style>
</head>
<body>
    <header>Мессенджер</header>
    <div class="container" id="mainContainer">
        <!-- Auth forms will be populated here -->
    </div>
    <footer>© 2023 Мессенджер</footer>

    <div class="notification" id="notification"></div>

    <script>
        let socket = null;
        let currentUser = null;
        let currentChat = null;
        let chats = [];

        function showPage(page) {
            document.getElementById('mainContainer').innerHTML = '';
            if (page === 'chats') {
                loadChats();
            } else if (page === 'profile') {
                loadProfile();
            } else if (page === 'login') {
                showLoginForm();
            } else if (page === 'register') {
                showRegisterForm();
            }
        }

        function loadChats() {
            const chatList = document.createElement('div');
            chatList.className = 'chat-list';
            chatList.id = 'chatList';
            chatList.innerHTML = '';
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.onclick = () => selectChat(chat);
                chatItem.innerHTML = `<img src="${chat.avatar}" alt="${chat.name}"><span>${chat.name}</span>`;
                chatList.appendChild(chatItem);
            });
            const chatContent = document.createElement('div');
            chatContent.className = 'chat-content';
            chatContent.innerHTML = `
                <div class="chat-header">
                    <h3 id="chatTitle">Выберите чат</h3>
                </div>
                <div class="chat-body" id="chatBody">
                </div>
                <div class="send-panel">
                    <input type="text" placeholder="Введите сообщение..." id="messageInput" onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button onclick="sendMessage()">Отправить</button>
                    <button class="attach-button" onclick="document.getElementById('fileInput').click()">Прикрепить</button>
                    <input type="file" id="fileInput" class="file-input" onchange="uploadFile()">
                </div>`;
            document.getElementById('mainContainer').appendChild(chatList);
            document.getElementById('mainContainer').appendChild(chatContent);
        }

        function selectChat(chat) {
            currentChat = chat;
            document.getElementById('chatTitle').innerText = chat.name;
            document.getElementById('chatBody').innerHTML = '';
            chat.messages.forEach(message => addMessageToChat(message));
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.chat-item span`).parentNode.classList.add('active');
        }

        function addMessageToChat(message) {
            const chatBody = document.getElementById('chatBody');
            const newMessage = document.createElement('div');
            newMessage.className = `message ${message.fromMe ? 'from-me' : 'from-them'}`;
            newMessage.innerHTML = `${message.text}<div class="time">${new Date(message.time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>`;
            chatBody.appendChild(newMessage);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            if (messageText && currentChat) {
                const newMessage = { text: messageText, time: new Date().getTime(), fromMe: true };
                currentChat.messages.push(newMessage);
                addMessageToChat(newMessage);
                messageInput.value = '';

                // Отправляем сообщение через WebSocket
                socket.send(JSON.stringify({
                    type: 'message',
                    chatId: currentChat.id,
                    message: newMessage
                }));
            }
        }

        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            console.log('Attempting to log in with:', { username, password });
            fetch('http://localhost:3000/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Login response:', data);
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    joinWebSocket();
                } else {
                    alert('Неверное имя пользователя или пароль');
                }
            })
            .catch(error => console.error('Error during login:', error));
        }

        function joinWebSocket() {
            const token = localStorage.getItem('token');
            console.log('Joining WebSocket with token:', token);
            fetch('http://localhost:3000/me', {
                method: 'GET',
                headers: { 'Authorization': token }
            })
            .then(response => response.json())
            .then(user => {
                console.log('Fetched user:', user);
                currentUser = user;
                socket = new WebSocket(`ws://${window.location.host}`);
                socket.onopen = () => {
                    console.log('WebSocket opened');
                    socket.send(JSON.stringify({ type: 'join', userId: currentUser._id }));
                };
                socket.onmessage = event => {
                    const messageData = JSON.parse(event.data);
                    if (messageData.type === 'message') {
                        const chat = chats.find(chat => chat.id === messageData.chatId);
                        if (chat) {
                            chat.messages.push(messageData.message);
                            addMessageToChat(messageData.message);
                            showNotification(`Новое сообщение от ${chat.name}`);
                        }
                    }
                };
                showPage('chats');
            })
            .catch(error => console.error('Error fetching user:', error));
        }

        function showLoginForm() {
            document.getElementById('mainContainer').innerHTML = `
                <div class="auth-form">
                    <div><input type="text" id="loginUsername" placeholder="Имя пользователя"></div>
                    <div><input type="password" id="loginPassword" placeholder="Пароль"></div>
                    <div><button onclick="login()">Войти</button></div>
                    <div><button onclick="showPage('register')">Регистрация</button></div>
                </div>`;
        }

        function showRegisterForm() {
            document.getElementById('mainContainer').innerHTML = `
                <div class="auth-form">
                    <div><input type="text" id="registerUsername" placeholder="Имя пользователя"></div>
                    <div><input type="password" id="registerPassword" placeholder="Пароль"></div>
                    <div><input type="text" id="registerName" placeholder="Имя"></div>
                    <div><input type="file" id="registerAvatar"></div>
                    <div><button onclick="register()">Зарегистрироваться</button></div>
                    <div><button onclick="showPage('login')">Войти</button></div>
                </div>`;
        }

        function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const name = document.getElementById('registerName').value;
            const avatar = document.getElementById('registerAvatar').files[0] ? URL.createObjectURL(document.getElementById('registerAvatar').files[0]) : 'https://via.placeholder.com/40';
            console.log('Attempting to register with:', { username, password, name, avatar });
            fetch('http://localhost:3000/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, name, avatar })
            })
            .then(response => response.text())
            .then(data => {
                console.log('Registration response:', data);
                alert('Регистрация успешна! Теперь вы можете войти.');
                showPage('login');
            })
            .catch(error => console.error('Error during registration:', error));
        }

        function logout() {
            localStorage.removeItem('token');
            socket.close();
            showPage('login');
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            notification.innerText = text;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                const newMessage = { text: `Файл: ${file.name}`, time: new Date().getTime(), fromMe: true };
                currentChat.messages.push(newMessage);
                addMessageToChat(newMessage);
                fileInput.value = '';
            }
        }

        function loadProfile() {
            document.getElementById('mainContainer').innerHTML = `
                <div style="padding: 20px;">
                    <h2>Профиль</h2>
                    <p>Имя: <input type="text" id="profileName" value="${currentUser ? currentUser.name : ''}"></p>
                    <p>Аватар: <input type="file" id="profileAvatar"></p>
                    <button onclick="saveProfile()">Сохранить</button>
                </div>`;
        }

        function saveProfile() {
            const profileName = document.getElementById('profileName').value;
            const profileAvatar = document.getElementById('profileAvatar').files[0];
            if (profileName) {
                currentUser = { name: profileName, avatar: profileAvatar ? URL.createObjectURL(profileAvatar) : currentUser.avatar };
                alert('Профиль сохранен!');
            }
        }

        // Initialize the app by showing the login page
        if (localStorage.getItem('token')) {
            joinWebSocket();
        } else {
            showPage('login');
        }
    </script>
</body>
</html>
