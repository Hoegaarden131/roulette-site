<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мессенджер</title>
    <style>
        /* ... (все стили из предыдущего примера) ... */
    </style>
</head>
<body>
    <header>Мессенджер</header>
    <div class="container" id="mainContainer">
        <!-- Auth forms will be populated here -->
    </div>
    <footer>© 2023 Мессенджер</footer>

    <div class="notification" id="notification"></div>

    <script>
        let socket = null;
        let currentUser = null;
        let currentChat = null;
        let chats = [];

        function showPage(page) {
            document.getElementById('mainContainer').innerHTML = '';
            if (page === 'chats') {
                loadChats();
            } else if (page === 'profile') {
                loadProfile();
            } else if (page === 'login') {
                showLoginForm();
            } else if (page === 'register') {
                showRegisterForm();
            }
        }

        function loadChats() {
            // ... (код загрузки чатов)
        }

        function selectChat(chat) {
            // ... (код выбора чата)
        }

        function addMessageToChat(message) {
            // ... (код добавления сообщения в чат)
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            if (messageText && currentChat) {
                const newMessage = { text: messageText, time: new Date().getTime(), fromMe: true };
                currentChat.messages.push(newMessage);
                addMessageToChat(newMessage);
                messageInput.value = '';
                
                // Отправляем сообщение через WebSocket
                socket.send(JSON.stringify({
                    type: 'message',
                    chatId: currentChat.id,
                    message: newMessage
                }));
            }
        }

        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            fetch('http://localhost:3000/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    joinWebSocket();
                } else {
                    alert('Неверное имя пользователя или пароль');
                }
            });
        }

        function joinWebSocket() {
            const token = localStorage.getItem('token');
            fetch('http://localhost:3000/me', {
                method: 'GET',
                headers: { 'Authorization': token }
            })
            .then(response => response.json())
            .then(user => {
                currentUser = user;
                socket = new WebSocket(`ws://${window.location.host}`);
                socket.onopen = () => {
                    socket.send(JSON.stringify({ type: 'join', userId: currentUser._id }));
                };
                socket.onmessage = event => {
                    const messageData = JSON.parse(event.data);
                    if (messageData.type === 'message') {
                        const chat = chats.find(chat => chat.id === messageData.chatId);
                        if (chat) {
                            chat.messages.push(messageData.message);
                            addMessageToChat(messageData.message);
                            showNotification(`Новое сообщение от ${chat.name}`);
                        }
                    }
                };
                showPage('chats');
            });
        }

        function showLoginForm() {
            // ... (код формы входа)
        }

        function showRegisterForm() {
            // ... (код формы регистрации)
        }

        function register() {
            // ... (код регистрации)
        }

        function logout() {
            // ... (код выхода)
        }

        // Initialize the app by showing the login page
        if (localStorage.getItem('token')) {
            joinWebSocket();
        } else {
            showPage('login');
        }
    </script>
</body>
</html>
